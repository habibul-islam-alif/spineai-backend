# SpineAI Backend

This is the backend for the SpineAI application, a FastAPI-based service that provides user authentication, chat functionalities with AI, payment processing through Stripe, and more.

## Getting Started

These instructions will get you a copy of the project up and running on your local machine for development and testing purposes.

### Prerequisites

- Python 3.12+
- PostgreSQL
- An active virtual environment

### Installation

1.  **Clone the repository:**

    ```bash
    git clone https://github.com/your-username/spineai-backend.git
    cd spineai-backend
    ```

2.  **Create and activate a virtual environment:**

    ```bash
    python -m venv .venv
    source .venv/bin/activate  # On Windows, use `.venv\Scripts\activate`
    ```

3.  **Install dependencies:**

    ```bash
    pip install -e .
    ```

4.  **Set up the database:**

    Ensure you have a PostgreSQL database created.

### Configuration

Create a `.env` file in the root of the project and add the following environment variables. You can use the `.env.example` file as a template.

```env
# Application Settings
APP_ENV=stage # or production
SITE_DOMIN=http://localhost:3000
DEBUG_MODE=True
LOG_LEVEL=INFO
JWT_SECRET_KEY=your-super-secret-key
ALGORITHM=HS256

# Database
DATABASE_URL=postgres://user:password@host:port/database_name

# OpenAI
OPENAI_API_KEY=your-openai-api-key
EMBEDDING_DIMENSIONS=1536
OPENAI_VECTOR_SIZE=1536

# Azure Document Intelligence
DOCUMENT_INTELLIGENCE_API_KEY=your-azure-api-key
DOCUMENT_INTELLIGENCE_ENDPOINT=your-azure-endpoint

# Stripe
STRIPE_API_KEY=your-stripe-api-key
STRIPE_WEBHOOK_SECRET=your-stripe-webhook-secret
STRIPE_SUCCESS_URL=http://localhost:3000/success
STRIPE_CANCEL_URL=http://localhost:3000/cancel

# Email (SMTP)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=465
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-email-password
FROM_EMAIL=your-email@gmail.com

# AWS S3
S3_ACCESS_KEY=your-s3-access-key
S3_SECRET_KEY=your-s3-secret-key
S3_REGION=your-s3-region
```

### Running the Application

Once the dependencies are installed and the `.env` file is configured, you can run the application using `uvicorn`:

```bash
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

The API will be available at `http://localhost:8000`.

## Project Structure

```
├── app/
│   ├── api/        # API endpoint definitions
│   ├── core/       # Core application settings and configuration
│   ├── db/         # Database configuration and initialization
│   ├── models/     # Tortoise ORM models
│   ├── schemas/    # Pydantic schemas for data validation
│   ├── services/   # Business logic and services (email, OCR, etc.)
│   └── ...
├── migrations/     # Database migration files generated by Aerich
└── ...
```

## API Endpoints

The API is versioned under `/v1`.

### Authentication (`/v1/auth`)

-   `POST /register`: Register a new user.
-   `POST /login`: Log in a user and get an access token.
-   `GET /me`: Get the current user's details.
-   `POST /resend-verification-email`: Resend the email verification link.
-   `GET /verify-email`: Verify a user's email address.
-   `PUT /change-password`: Change the current user's password.
-   `POST /forgot-password`: Request a password reset link.
-   `POST /reset-password`: Reset the password using a token.
-   `PUT /update-profile`: Update the current user's profile.
-   `GET /users`: Get a list of all users (admin only).
-   `POST /logout`: Log out the current user.

### Chat (`/v1/chat`)

-   `POST /session/create`: Create a new chat session.
-   `GET /session/all`: Get all chat sessions for the current user.
-   `GET /session/{session_id}/all`: Get all messages for a specific chat session.
-   `POST /session/{session_id}/send`: Send a message in a chat session.
-   `DELETE /session/{session_id}/delete`: Delete a chat session.
-   `PUT /session/{session_id}/update`: Rename a chat session.

### Payments (`/v1/payment`)

-   `GET /plan/all`: Get a list of all available subscription plans.
-   `POST /plan/create`: Create a new subscription plan (admin only).
-   `POST /plan/{plan_id}/update`: Update a subscription plan (admin only).
-   `POST /stripe/create-session/{product_id}`: Create a Stripe checkout session.
-   `GET /stripe/customer-portal`: Get a link to the Stripe customer portal.
-   `POST /webhook/stripe`: Handle Stripe webhooks.

### Feedback (`/v1/feedback`)

-   `POST /create`: Submit feedback.
-   `GET /all`: Get all feedback (admin only).
-   `POST /contact-us/create`: Submit a contact form.
-   `GET /contact-us/all`: Get all contact form submissions (admin only).

## Database

This project uses [Tortoise ORM](https://tortoise.github.io/) to interact with the PostgreSQL database and [Aerich](https://github.com/tortoise/aerich) for database migrations.

### Migrations

-   **Initialize migrations (first time only):**

    ```bash
    aerich init -t app.db.config.TORTOISE_ORM
    aerich init-db
    ```

-   **Create a new migration:**

    ```bash
    aerich migrate
    ```

-   **Apply migrations:**

    ```bash
    aerich upgrade
    ```

## Deployment

The application is configured to run in two environments: `stage` and `production`. The environment is determined by the `APP_ENV` environment variable.

-   **Staging:** Uses `stage_plans.json` for subscription plans.
-   **Production:** Uses `production_plans.json` for subscription plans.

Make sure to set `APP_ENV=production` and `DEBUG_MODE=False` in your production environment.
